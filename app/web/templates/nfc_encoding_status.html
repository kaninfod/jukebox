<!DOCTYPE html>
<html>
<head>
    <title>NFC Encoding Status</title>
    {% include '_global_styles.html' %}
    <style>
        .status-container {
            margin: 40px auto;
            padding: 24px;
            max-width: 400px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background: #f9f9f9;
            text-align: center;
        }
        .status-title { font-size: 1.4em; margin-bottom: 12px; }
        .status-active { color: #155724; background: #d4edda; padding: 8px; border-radius: 4px; }
        .status-inactive { color: #721c24; background: #f8d7da; padding: 8px; border-radius: 4px; }
        .btn { margin-top: 18px; padding: 8px 18px; border: none; border-radius: 4px; background: #0074d9; color: #fff; font-size: 1em; cursor: pointer; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>
    {% from '_navbar.html' import navbar %}
    {{ navbar() }}
    <div class="status-container">
        <div class="status-title">NFC Encoding Session Status</div>
    <div id="encodingStatus" class="status-inactive">Loading...</div>
    <div id="successMessage" class="status-message success" style="display:none;">âœ… Card encoded successfully!</div>
    <button id="stopBtn" class="btn" style="display:none;">Stop Encoding Session</button>
    </div>
    <script>
        let polling = true;
        let pollInterval = null;
        async function fetchStatus() {
            if (!polling) return;
            const resp = await fetch('/api/nfc-encoding/status');
            const data = await resp.json();
            const statusDiv = document.getElementById('encodingStatus');
            const stopBtn = document.getElementById('stopBtn');
            const successDiv = document.getElementById('successMessage');
            if (data.encoding_mode) {
                statusDiv.textContent = 'Encoding session is ACTIVE';
                statusDiv.className = 'status-active';
                stopBtn.style.display = 'inline-block';
                stopBtn.disabled = false;
                successDiv.style.display = 'none';
            } else {
                statusDiv.textContent = 'No encoding session active. last encoding data: ' + (data.album_id || 'N/A') + ' / ' + (data.last_uid || 'N/A');
                statusDiv.className = 'status-inactive';
                stopBtn.style.display = 'none';
                // Show success message and stop polling
                successDiv.style.display = 'block';
                polling = false;
                if (pollInterval) clearInterval(pollInterval);
            }
        }
        document.getElementById('stopBtn').onclick = async function() {
            this.disabled = true;
            await fetch('/api/nfc-encoding/stop', { method: 'POST' });
            await fetchStatus();
        };
        fetchStatus();
        pollInterval = setInterval(fetchStatus, 3000);
    </script>
</body>
</html>
