{% extends "_base.html" %}

{% block title %}Subsonic Albums — {{ artist_name or artist_id }}{% endblock %}

{% block active_page %}library{% endblock %}

{% block head_extra %}
<style>
    .album-grid { gap: 1rem; }
    .status-message { display:none; }
    .album-card { width: 13rem; display: flex; flex-direction: column; }
    .album-media { height: 180px; }
    .album-media img { height: 100%; width: 100%; object-fit: cover; }
    .album-media .placeholder { height: 100%; }
    .album-card .card-body { display: flex; flex-direction: column; }
    .card-title.line-clamp-2 {
        line-clamp: 2; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/library/artists">Music Library</a></li>
            {% if artist_name %}
                <li class="breadcrumb-item active" aria-current="page">{{ artist_name }}</li>
            {% endif %}
        </ol>
    </nav>

    <h2 class="h4 mb-3">Albums for: {{ artist_name or artist_id }}</h2>

    <div id="statusMessage" class="alert status-message" role="alert"></div>

        <div class="d-flex flex-wrap album-grid">
        {% for album in albums %}
                <div class="card album-card">
                    <a href="/library/albums/{{ album.id }}?artist_id={{ artist_id }}&artist_name={{ artist_name|urlencode }}&album_name={{ album.name|urlencode }}" class="text-decoration-none text-reset">
                        <div class="album-media">
                            {% if album.cover_url %}
                                <img src="{{ album.cover_url }}" class="card-img-top" alt="Cover of {{ album.name }}" width="180" height="180" loading="lazy">
                            {% else %}
                                <div class="placeholder d-flex align-items-center justify-content-center bg-light text-muted">
                                    <span>No image</span>
                                </div>
                            {% endif %}
                        </div>
                    </a>
                    <div class="card-body d-flex flex-column">
                        <h6 class="card-title line-clamp-2 mb-1" title="{{ album.name }}">{{ album.name }}</h6>
                        <h6 class="card-subtitle mb-2 text-muted">{% if artist_name %}{{ artist_name }}{% else %}&nbsp;{% endif %}</h6>
                        {% set year = album.get('year') %}
                        {% if year %}<div class="text-muted small">{{ year }}</div>{% endif %}
                        <div class="text-muted small mt-auto text-end">{{ album.id }}</div>
                    </div>
                    <div class="card-footer bg-transparent border-0 mt-auto">
                        <div class="d-flex align-items-center w-100">
                            <a href="#" class="link-primary small" onclick="startNfcEncoding('{{ album.id }}', '{{ album.name }}', this); return false;">Encode</a>
                            <button class="btn btn-success btn-sm ms-auto" onclick="playOnJukebox('{{ album.id }}', '{{ album.name }}', this)">Play</button>
                        </div>
                    </div>
            </div>
        {% endfor %}
    </div>

    
{% endblock %}

{% block scripts %}
<script>
    function setStatus(type, message) {
        const statusDiv = document.getElementById('statusMessage');
        statusDiv.className = `alert status-message ${type === 'success' ? 'alert-success' : 'alert-danger'}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
    }

    function playOnJukebox(albumId, albumName, button) {
        button.disabled = true;
        button.textContent = 'Loading...';
        document.getElementById('statusMessage').style.display = 'none';
        fetch(`/api/mediaplayer/play_album_from_albumid/${albumId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                setStatus('success', `Now playing: ${albumName}`);
                button.textContent = '✓ Playing';
            } else {
                setStatus('error', `Failed to play: ${data.message}`);
                button.textContent = 'Play';
                button.disabled = false;
            }
        })
        .catch(error => {
            setStatus('error', `Error: ${error.message}`);
            button.textContent = 'Play';
            button.disabled = false;
        });
    }

    function startNfcEncoding(albumId, albumName, button) {
        // Support both buttons and links
        button.textContent = 'Starting...';
        if (button.tagName && button.tagName.toLowerCase() === 'a') {
            button.classList.add('disabled');
            button.setAttribute('aria-disabled', 'true');
            button.style.pointerEvents = 'none';
        } else {
            button.disabled = true;
        }
        document.getElementById('statusMessage').style.display = 'none';
        fetch('/api/nfc-encoding/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ album_id: albumId })
        })
        .then(response => {
            if (!response.ok) throw new Error('Failed to start encoding session');
            window.location.href = `/nfc-encoding/status-page?album_id=${albumId}&album_name=${encodeURIComponent(albumName)}`;
        })
        .catch(error => {
            setStatus('error', `Error: ${error.message}`);
            button.textContent = 'Encode';
            if (button.tagName && button.tagName.toLowerCase() === 'a') {
                button.classList.remove('disabled');
                button.removeAttribute('aria-disabled');
                button.style.pointerEvents = '';
            } else {
                button.disabled = false;
            }
        });
    }
</script>
{% endblock %}
