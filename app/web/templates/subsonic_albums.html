<!DOCTYPE html>
<html>
<head>
    <title>Subsonic Albums</title>
    <style>
        table { margin: auto; border-collapse: collapse; }
        th, td { padding: 8px 12px; border: 1px solid #ccc; }
        .play-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }
        .play-btn:hover { background-color: #45a049; }
        .play-btn:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        .status-message {
            margin: 10px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h2 style="text-align:center;">Albums for Artist: {{ artist_id }}</h2>
    
    <div id="statusMessage" class="status-message" style="display:none;"></div>
    
    <table>
        <tr>
            <th>Album Name</th>
            <th>Album ID</th>
            <th>Action</th>
            <th>NFC Encode</th>
        </tr>
        {% for album in albums %}
        <tr>
            <td>{{ album.name }}</td>
            <td>{{ album.id }}</td>
            <td>
                <button class="play-btn" onclick="playOnJukebox('{{ album.id }}', '{{ album.name }}', this)">
                    Play on Jukebox
                </button>
            </td>
            <td>
                <button class="play-btn" onclick="startNfcEncoding('{{ album.id }}', '{{ album.name }}', this)">
                    Encode NFC Card
                </button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <div style="text-align:center; margin-top:20px;">
        <a href="/subsonic/artists">Back to Artists</a> |
        <a href="/nfc-encoding/status-page">NFC Encoding Status</a>
    </div>

    <script>
        function playOnJukebox(albumId, albumName, button) {
            button.disabled = true;
            button.textContent = 'Loading...';
            document.getElementById('statusMessage').style.display = 'none';
            fetch('/mediaplayer/playback_album_id', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ album_id: albumId, provider: 'subsonic' })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                if (data.status === 'success') {
                    statusDiv.className = 'status-message success';
                    statusDiv.textContent = `✅ Now playing: ${albumName}`;
                    button.textContent = '✓ Playing';
                } else {
                    statusDiv.className = 'status-message error';
                    statusDiv.textContent = `❌ Failed to play: ${data.message}`;
                    button.textContent = 'Play on Jukebox';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-message error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                button.textContent = 'Play on Jukebox';
                button.disabled = false;
            });
        }

        function startNfcEncoding(albumId, albumName, button) {
            button.disabled = true;
            button.textContent = 'Starting...';
            document.getElementById('statusMessage').style.display = 'none';
            fetch('/nfc-encoding/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ album_id: albumId })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to start encoding session');
                // Prompt user to present card and poll for status
                window.location.href = `/nfc-encoding/status-page?album_id=${albumId}&album_name=${encodeURIComponent(albumName)}`;
            })
            .catch(error => {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-message error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                button.textContent = 'Encode NFC Card';
                button.disabled = false;
            });
        }
    </script>
</body>
</html>
