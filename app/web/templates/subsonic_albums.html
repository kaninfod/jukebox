<!DOCTYPE html>
<html>
<head>
    <title>Subsonic Albums</title>
    {% include '_global_styles.html' %}
    <style>
        table { margin: auto; border-collapse: collapse; }
        th, td { padding: 8px 12px; border: 1px solid #ccc; }
        .play-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
        }
        .play-btn:hover { background-color: #45a049; }
        .play-btn:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
        }
        .status-message {
            margin: 10px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    {% from '_navbar.html' import navbar %}
    {{ navbar('library') }}
    <div style="margin-bottom:20px;text-align:center;">
        <a href="/subsonic/artists">Music Library</a>
        {% if artist_name %}
            &gt; <span>{{ artist_name }}</span>
        {% endif %}
    </div>
    <h2 style="text-align:center;">Albums for Artist: {{ artist_name or artist_id }}</h2>
    
    <div id="statusMessage" class="status-message" style="display:none;"></div>
    
    <table>
        <tr>
            <th>Cover</th>
            <th>Album Name</th>
            <th>Album ID</th>
            <th>Action</th>
            <th>NFC Encode</th>
        </tr>
        {% for album in albums %}
        <tr>
            <td>
                {% if album.cover_url %}
                    {% set cover_url = album.cover_url %}
                    {% if request.scheme == 'https' and cover_url.startswith('http://192.168.68.102:4747') %}
                        {% set cover_url = cover_url.replace('http://192.168.68.102:4747', 'https://gonic.hinge.lan') %}
                    {% endif %}
                    <img data-src="{{ cover_url }}" src="" alt="Cover" style="width:80px;height:80px;object-fit:cover;border-radius:6px;" class="album-cover-img" />
                {% else %}
                    <span style="color:#aaa;font-size:12px;">No image</span>
                {% endif %}
            </td>
            <td>
                <a href="/subsonic/album/{{ album.id }}?artist_id={{ artist_id }}&artist_name={{ artist_name|urlencode }}&album_name={{ album.name|urlencode }}" style="text-decoration:none;color:#333;">
                    {{ album.name }}
                </a>
            </td>
            <td>{{ album.id }}</td>
            <td>
                <button class="play-btn" onclick="playOnJukebox('{{ album.id }}', '{{ album.name }}', this)">
                    Play on Jukebox
                </button>
            </td>
            <td>
                <button class="play-btn" onclick="startNfcEncoding('{{ album.id }}', '{{ album.name }}', this)">
                    Encode NFC Card
                </button>
            </td>
        </tr>
        {% endfor %}
    </table>

    <div style="text-align:center; margin-top:20px;">
        <a href="/subsonic/artists">Back to Artists</a> |
        <a href="/nfc-encoding/status-page">NFC Encoding Status</a>
    </div>

    <script>
        // Set album cover src from data-src, rewriting to HTTPS if needed, before any HTTP request is made
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.album-cover-img').forEach(function(img) {
                let url = img.getAttribute('data-src');
                if (window.location.protocol === 'https:' && url && url.startsWith('http://192.168.68.102:4747')) {
                    url = url.replace('http://192.168.68.102:4747', 'https://gonic.hinge.lan');
                }
                if (url) img.src = url;
            });
        });
        function playOnJukebox(albumId, albumName, button) {
            button.disabled = true;
            button.textContent = 'Loading...';
            document.getElementById('statusMessage').style.display = 'none';
            fetch(`/api/mediaplayer/play_album_from_albumid/${albumId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
                // body: JSON.stringify({ album_id: albumId, provider: 'subsonic' })
            })
            .then(response => response.json())
            .then(data => {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                if (data.status === 'success') {
                    statusDiv.className = 'status-message success';
                    statusDiv.textContent = `✅ Now playing: ${albumName}`;
                    button.textContent = '✓ Playing';
                } else {
                    statusDiv.className = 'status-message error';
                    statusDiv.textContent = `❌ Failed to play: ${data.message}`;
                    button.textContent = 'Play on Jukebox';
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-message error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                button.textContent = 'Play on Jukebox';
                button.disabled = false;
            });
        }

        function startNfcEncoding(albumId, albumName, button) {
            button.disabled = true;
            button.textContent = 'Starting...';
            document.getElementById('statusMessage').style.display = 'none';
            fetch('/api/nfc-encoding/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ album_id: albumId })
            })
            .then(response => {
                if (!response.ok) throw new Error('Failed to start encoding session');
                // Prompt user to present card and poll for status
                window.location.href = `/nfc-encoding/status-page?album_id=${albumId}&album_name=${encodeURIComponent(albumName)}`;
            })
            .catch(error => {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.style.display = 'block';
                statusDiv.className = 'status-message error';
                statusDiv.textContent = `❌ Error: ${error.message}`;
                button.textContent = 'Encode NFC Card';
                button.disabled = false;
            });
        }
    </script>
</body>
</html>
