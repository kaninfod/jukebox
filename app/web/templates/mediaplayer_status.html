<!DOCTYPE html>
<head>
    <title>Jukeplayer</title>
    {% include '_global_styles.html' %}
</head>
<body>
    {% from '_navbar.html' import navbar %}
    {{ navbar('player') }}
    <div class="main-content">
        <div class="current-track-frame">
            <div style="padding:24px 24px 16px 24px; width:100%; display:flex; flex-direction:column; align-items:center; height:100%; box-sizing:border-box;">
                <div id="track-thumb"></div>
                <div id="track-info">Loading...</div>
            </div>
        </div>
        <div class="playlist-frame">
            <div style="padding:18px 0 18px 0; height:100%; box-sizing:border-box; display:flex; flex-direction:column;">
                <div class="playlist-title">Playlist</div>
                <div class="playlist-list" id="playlist-list">
                    <!-- Playlist will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    <div class="controls">
        <button onclick="control('previous_track')">Prev</button>
        <button onclick="control('play_pause')">Play/Pause</button>
        <button onclick="control('next_track')">Next</button>
        <button onclick="control('stop')">Stop</button>
        <button onclick="control('volume_up')">Vol +</button>
        <button onclick="control('volume_down')">Vol -</button>
    </div>
    <script>
        // WebSocket for live track info
        const ws = new WebSocket(`wss://${window.location.host}/ws/mediaplayer/current_track`);
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.status === 'ping') {
                return;
            }
            const infoDiv = document.getElementById('track-info');
            const thumbDiv = document.getElementById('track-thumb');
            if (data.current_track) {
                infoDiv.innerHTML = `
                    <strong>${data.current_track.artist}</strong><br>
                    <strong>${data.current_track.title}</strong><br>
                    Album: ${data.current_track.album}<br>
                    Year: ${data.current_track.year}<br>
                    Status: ${data.status}<br>
                    Track ${data.current_track.track_number} of ${data.playlist.length} in playlist
                `;
                let thumbUrl = data.current_track.thumb;
                if (thumbUrl) {
                    thumbDiv.innerHTML = `<img src="${thumbUrl}" alt="Cover" style="width:120px;height:120px;object-fit:cover;border-radius:10px;box-shadow:0 2px 8px #aaa;" />`;
                } else {
                    thumbDiv.innerHTML = '';
                }
            } else {
                infoDiv.innerHTML = data.message || 'No track loaded';
                thumbDiv.innerHTML = '';
            }

            // Render playlist
            const playlistDiv = document.getElementById('playlist-list');
            if (data.playlist && Array.isArray(data.playlist)) {
                let html = '';
                for (let i = 0; i < data.playlist.length; i++) {
                    const track = data.playlist[i];
                    const isCurrent = data.current_track && (track.track_number === data.current_track.track_number);
                    html += `<div class="playlist-track${isCurrent ? ' current' : ''}">` +
                        `<div class="playlist-track-number">${track.track_number || i+1}</div>` +
                        `<div class="playlist-track-title">${isCurrent ? '<span style=\"color:#1976d2;font-size:1.2em;vertical-align:middle;\">&#9654;</span> ' : ''}${track.title || ''}</div>` +
                        `<div class="playlist-track-duration">${formatDuration(track.duration)}</div>` +
                    `</div>`;
                }
                playlistDiv.innerHTML = html;
            } else {
                playlistDiv.innerHTML = '<div style="color:#888;text-align:center;">No playlist loaded</div>';
            }
        };

        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return '';
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function control(action) {
            fetch(`/api/mediaplayer/${action}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    // Optionally show feedback
                });
        }
    </script>
</body>
