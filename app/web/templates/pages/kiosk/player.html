{% extends "layouts/kiosk_base.html" %}

{% block title %}Jukeplayer â€” Player (Kiosk){% endblock %}

{% block kiosk_content %}
    {% include 'components/kiosk/_player_status.html' %}
{% endblock %}

{% block scripts %}

<script>
    // WebSocket for live track info
    const ws = new WebSocket(`wss://${window.location.host}/ws/mediaplayer/current_track`);
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.status === 'ping') {
            return;
        }
        updateKioskTrackInfo(data);
    };

    function updateKioskTrackInfo(data) {
        const kioskInfoDiv = document.getElementById('kiosk-track-info');
        const kioskThumbDiv = document.getElementById('kiosk-track-thumb');
        const deviceDiv = document.getElementById('current-device');
        
        // Update Chromecast device name
        if (data.chromecast_device) {
            deviceDiv.textContent = data.chromecast_device;
        }
        
        if (data.current_track) {
            kioskInfoDiv.innerHTML = `
                <div class="kiosk-status">
                    <span><i class="mdi mdi-music-note"></i> Track ${data.current_track.track_number} of ${data.playlist.length}</span>
                    <span><i class="mdi mdi-volume-high"></i> ${data.volume}%</span>
                </div>
                <div class="kiosk-artist">${data.current_track.artist}</div>
                <div class="kiosk-title">${data.current_track.title}</div>
                <div class="kiosk-album">${data.current_track.album} (${data.current_track.year})</div>
            `;
            let thumbUrl = data.current_track.thumb;
            if (thumbUrl) {
                kioskThumbDiv.innerHTML = `<img src="${thumbUrl}" alt="Album Cover" />`;
            } else {
                kioskThumbDiv.innerHTML = '<div class="kiosk-no-cover"><i class="mdi mdi-music"></i></div>';
            }
        } else {
            kioskInfoDiv.innerHTML = '<div class="kiosk-no-track">' + (data.message || 'No track loaded') + '</div>';
            kioskThumbDiv.innerHTML = '<div class="kiosk-no-cover"><i class="mdi mdi-music"></i></div>';
        }
    }

    function control(action) {
        fetch(`/api/mediaplayer/${action}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                // Optionally show feedback
            });
    }

    // Navigation functions (will be enhanced in Phase 7)
    function navigateTo(section) {
        console.log('Navigate to:', section);
        // TODO: Implement dynamic loading
        if (typeof kioskLoader !== 'undefined') {
            kioskLoader.loadContent(section);
        }
    }

    function selectDevice() {
        console.log('Select Chromecast device');
        // TODO: Load device selector component
        if (typeof kioskLoader !== 'undefined') {
            kioskLoader.loadContent('devices');
        }
    }
</script>
{% endblock %}
